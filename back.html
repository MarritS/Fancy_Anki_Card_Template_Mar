

<div class="card-container">

  <!-- Normal (always-visible) tags -->
  <div class="tag-container" id="tagContainer"></div>

  <!-- qt* tags above the question -->
  <div class="tag-container tag-container--question" id="qtContainer"></div>
  <div class="front-card">{{Front}}</div>

  <!-- at* tags above the answer (only shown on back) -->
  <div class="tag-container tag-container--answer" id="atContainer"></div>
  <div class="common-card">{{Back}}</div>

  {{#Extra}}
  <div class="common-card">
    <div class="subtitle subtitle--extra"></div>
    <div class="reminder reminder--extra"></div>
    {{Extra}}
  </div>
  {{/Extra}}

  {{#Hint}}
  <div class="common-card">
    <div class="subtitle subtitle--hint"></div>
    {{Hint}}
  </div>
  {{/Hint}}

  {{#Source}}
  <div class="common-card">
    <div class="subtitle subtitle--source"></div>
    {{Source}}
  </div>
  {{/Source}}

</div>

<span hidden id="tagSource">{{Tags}}</span>

<script>
/* ============================================================
   TAG RENDERING â€“ BACK
   ------------------------------------------------------------
   normal tags    -> #tagContainer
   qt* (prefix)   -> #qtContainer (above question)
   ::at (suffix)  -> #atContainer (above answer)
   hid* (prefix)  -> never shown
   leech          -> always shown FIRST (special color)
============================================================ */

(() => {
  const tagSourceEl = document.getElementById("tagSource");
  const normalEl = document.getElementById("tagContainer");
  const qtEl = document.getElementById("qtContainer");
  const atEl = document.getElementById("atContainer");

  if (!tagSourceEl || !normalEl || !qtEl || !atEl) return;

  const raw = (tagSourceEl.textContent || "").trim();
  if (!raw) return;

  const PREFIX = {
    qt:  /^qt(?:[:\-_ ]+|$)/i,
    hid: /^hid(?:[:\-_ ]+|$)/i
  };

  const stripPrefix = (s) =>
    s.replace(/^(qt|hid)(?:[:\-_ ]+|$)/i, "").trim();

  const tokens = raw.split(/\s+/).filter(Boolean);

  const normal = []; // {label, type}
  const qt = [];     // {label, type}
  const at = [];     // {label, type}

  for (const token of tokens) {
    const parts = token.split("::").filter(Boolean);
    if (!parts.length) continue;

    const lastRaw = parts[parts.length - 1];
    const last = lastRaw.toLowerCase();

    // --- Special: leech tag (always visible, ALWAYS FIRST) ---
    if (last === "leech") {
      normal.unshift({ label: "leech", type: "leech" });
      continue;
    }

    // --- hid prefix on last segment => never show anywhere ---
    if (PREFIX.hid.test(lastRaw)) continue;

    // --- qt prefix on last segment => show above question ---
    if (PREFIX.qt.test(lastRaw)) {
      const label = stripPrefix(lastRaw).replace(/_/g, " ");
      if (label) qt.push({ label, type: "question" });
      continue;
    }

    // --- ::at suffix => show above answer (label from previous segment) ---
    if (last === "at") {
      const prev = parts.length >= 2 ? parts[parts.length - 2] : "";
      const label = prev.replace(/_/g, " ").trim();
      if (label) at.push({ label, type: "answer" });
      continue;
    }

    // --- normal tag => show last segment ---
    const label = lastRaw.replace(/_/g, " ").trim();
    if (label) normal.push({ label, type: "normal" });
  }

  const addPills = (container, items) => {
    if (!items.length) return;
    const frag = document.createDocumentFragment();

    for (const item of items) {
      const el = document.createElement("div");
      el.className = `tags tags--${item.type}`;
      el.textContent = item.label;
      frag.appendChild(el);
    }

    container.appendChild(frag);
  };

  addPills(normalEl, normal);
  addPills(qtEl, qt);
  addPills(atEl, at);

  if (!normalEl.children.length) normalEl.style.display = "none";
  if (!qtEl.children.length) qtEl.style.display = "none";
  if (!atEl.children.length) atEl.style.display = "none";
})();
</script>